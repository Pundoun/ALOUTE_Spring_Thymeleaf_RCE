<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Preview - ALOUTE</title>
    <link rel="icon" type="image/png" th:href="@{/images/logos/hcmute.png}">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5;
        }
        .preview-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
        }
        .preview-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .preview-card img {
            max-width: 100%;
            border-radius: 4px;
            margin-top: 10px;
        }
        .url-input {
            font-family: monospace;
        }
        .example-urls {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .example-url {
            cursor: pointer;
            color: #0d6efd;
            text-decoration: underline;
            margin: 5px 0;
            display: block;
            font-size: 0.9em;
        }
        .example-url:hover {
            color: #0a58ca;
            background: #e9ecef;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .vulnerability-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="preview-container">
        <a href="/" class="back-link">
            <i class="bi bi-arrow-left"></i> Back to Home
        </a>

        <h2><i class="bi bi-link-45deg"></i> URL Preview Tool</h2>
        <p class="text-muted">Preview metadata from any URL - Test SSRF vulnerability</p>

        <!-- Vulnerability Warning -->
        <div class="vulnerability-warning">
            <h5><i class="bi bi-exclamation-triangle"></i> Lab Environment - SSRF Vulnerability</h5>
            <p class="mb-0"><strong>This feature is intentionally vulnerable to SSRF attacks for educational purposes.</strong></p>
            <small>Try scanning internal services: <code>http://127.0.0.1:3306</code>, <code>http://localhost:8081</code>, etc.</small>
        </div>

        <!-- Input Form -->
        <div class="card">
            <div class="card-body">
                <div class="mb-3">
                    <label for="urlInput" class="form-label"><strong>Enter URL to Preview:</strong></label>
                    <input type="text"
                           class="form-control url-input"
                           id="urlInput"
                           placeholder="https://example.com or http://127.0.0.1:3306"
                           value="http://localhost:8081">
                </div>
                <button class="btn btn-primary" id="previewBtn">
                    <i class="bi bi-search"></i> Preview URL
                </button>
                <button class="btn btn-secondary" id="clearBtn">
                    <i class="bi bi-x-circle"></i> Clear
                </button>

                <!-- Example URLs -->
                <div class="example-urls">
                    <small class="text-muted fw-bold">Quick Test URLs (Click to use):</small>
                    <a class="example-url text-success" data-url="http://localhost:8081">
                        <i class="bi bi-check-circle"></i> http://localhost:8081 - Test normal request
                    </a>
                    <a class="example-url text-danger" data-url="http://127.0.0.1:3306">
                        <i class="bi bi-shield-exclamation"></i> http://127.0.0.1:3306 - SSRF: Scan MariaDB port
                    </a>
                    <a class="example-url text-danger" data-url="http://127.0.0.1:22">
                        <i class="bi bi-shield-exclamation"></i> http://127.0.0.1:22 - SSRF: Scan SSH port
                    </a>
                    <a class="example-url text-danger" data-url="http://192.168.1.1">
                        <i class="bi bi-shield-exclamation"></i> http://192.168.1.1 - SSRF: Internal network
                    </a>
                    <a class="example-url text-danger" data-url="http://169.254.169.254/latest/meta-data/">
                        <i class="bi bi-shield-exclamation"></i> http://169.254.169.254/latest/meta-data/ - SSRF: AWS Metadata
                    </a>
                    <a class="example-url" data-url="https://www.google.com">
                        <i class="bi bi-globe"></i> https://www.google.com - Normal external URL
                    </a>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loadingIndicator" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Fetching URL preview...</p>
        </div>

        <!-- Preview Result -->
        <div class="preview-card" id="previewResult" style="display: none;">
            <h4 id="previewTitle" class="text-primary">Title</h4>
            <p class="text-muted" id="previewDescription">Description</p>
            <img id="previewImage" src="" alt="Preview Image" style="display: none;">

            <hr>

            <div class="row">
                <div class="col-md-6">
                    <small class="text-muted"><strong>Requested URL:</strong></small>
                    <p class="small font-monospace text-break" id="previewUrl">-</p>
                </div>
                <div class="col-md-3">
                    <small class="text-muted"><strong>HTTP Status:</strong></small>
                    <p class="small" id="previewStatus">-</p>
                </div>
                <div class="col-md-3">
                    <small class="text-muted"><strong>Content Type:</strong></small>
                    <p class="small" id="previewContentType">-</p>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div class="alert alert-danger" id="errorMessage" style="display: none;">
            <strong><i class="bi bi-x-circle"></i> Error:</strong> <span id="errorText"></span>
        </div>

        <!-- Debug Info -->
        <div class="alert alert-info mt-3" id="debugInfo" style="display: none;">
            <strong><i class="bi bi-info-circle"></i> Debug Info:</strong>
            <pre id="debugText" class="mb-0 mt-2" style="font-size: 0.85em;"></pre>
        </div>
    </div>

    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script>
        console.log('URL Preview page loaded');

        $(document).ready(function() {
            console.log('jQuery loaded successfully');

            const API_BASE_URL = window.location.origin;
            console.log('API Base URL:', API_BASE_URL);

            // Get JWT token from localStorage - FIXED: use 'jwt' key instead of 'token'
            function getToken() {
                const token = localStorage.getItem('jwt');
                console.log('Token from localStorage (key: jwt):', token ? 'Found - ' + token.substring(0, 50) + '...' : 'Not found');
                return token;
            }

            // Preview URL function
            function previewUrl() {
                const url = $('#urlInput').val().trim();
                console.log('Preview button clicked, URL:', url);

                if (!url) {
                    alert('Please enter a URL');
                    return;
                }

                const token = getToken();
                if (!token) {
                    $('#errorText').html('No authentication token found. Please <a href="/auth/login">login</a> first.');
                    $('#errorMessage').show();
                    console.error('No token found in localStorage with key "jwt"');
                    return;
                }

                // Show loading
                $('#loadingIndicator').show();
                $('#previewResult').hide();
                $('#errorMessage').hide();
                $('#debugInfo').hide();

                const requestData = { url: url };
                console.log('Sending request:', requestData);
                console.log('Using token:', token.substring(0, 50) + '...');

                // Call SSRF endpoint
                $.ajax({
                    url: API_BASE_URL + '/api/posts/preview-url',
                    type: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify(requestData),
                    success: function(response) {
                        console.log('Success response:', response);
                        const result = response.result;

                        // Hide loading
                        $('#loadingIndicator').hide();

                        // Show result
                        $('#previewTitle').text(result.title || 'No title available');
                        $('#previewDescription').text(result.description || 'No description available');
                        $('#previewUrl').text(result.url);

                        // Status badge with color
                        let badgeClass = 'secondary';
                        if (result.statusCode === 200) badgeClass = 'success';
                        else if (result.statusCode === -1) badgeClass = 'danger';
                        else if (result.statusCode >= 400) badgeClass = 'warning';

                        $('#previewStatus').html('<span class="badge bg-' + badgeClass + '">' +
                            result.statusCode + '</span>');
                        $('#previewContentType').text(result.contentType || 'N/A');

                        // Show image if available
                        if (result.imageUrl && result.imageUrl.length > 0) {
                            $('#previewImage').attr('src', result.imageUrl).show();
                        } else {
                            $('#previewImage').hide();
                        }

                        $('#previewResult').show();

                        // Show debug info
                        $('#debugText').text(JSON.stringify(result, null, 2));
                        $('#debugInfo').show();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error response:', xhr, status, error);
                        $('#loadingIndicator').hide();

                        let errorMsg = 'Failed to fetch URL preview';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        } else if (xhr.status === 401) {
                            errorMsg = 'Unauthorized - Please login first';
                        } else if (xhr.status === 403) {
                            errorMsg = 'Forbidden - Access denied';
                        } else if (xhr.statusText) {
                            errorMsg += ': ' + xhr.statusText;
                        }

                        $('#errorText').text(errorMsg);
                        $('#errorMessage').show();

                        // Show debug info
                        $('#debugText').text('Status: ' + xhr.status + '\n' +
                                           'Error: ' + error + '\n' +
                                           'Response: ' + JSON.stringify(xhr.responseJSON, null, 2));
                        $('#debugInfo').show();
                    }
                });
            }

            // Preview button click
            $('#previewBtn').on('click', function() {
                console.log('Preview button clicked');
                previewUrl();
            });

            // Clear button
            $('#clearBtn').on('click', function() {
                console.log('Clear button clicked');
                $('#urlInput').val('');
                $('#previewResult').hide();
                $('#errorMessage').hide();
                $('#debugInfo').hide();
            });

            // Example URL click
            $('.example-url').on('click', function(e) {
                e.preventDefault();
                const url = $(this).data('url');
                console.log('Example URL clicked:', url);
                $('#urlInput').val(url);
            });

            // Enter key to submit
            $('#urlInput').on('keypress', function(e) {
                if (e.which === 13) {
                    console.log('Enter key pressed');
                    previewUrl();
                }
            });

            console.log('All event handlers attached');
        });
    </script>
</body>
</html>
